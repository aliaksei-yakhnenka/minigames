<!DOCTYPE html>
<html>
<head>
  <title>snake</title>
  <script type="text/javascript">
    var canvas;
    var ctx;
    var cycle;

    var DIR_U = 1;
    var DIR_L = 2;
    var DIR_D = 3;
    var DIR_R = 4;

    var COLOR_GRID = 'rgba(200, 200, 200, .5)';
    var COLOR_SNAKE = 'rgba(0, 0, 255, .5)';
    var COLOR_FOOD = 'rgba(0, 255, 0, .5)';

    var fieldSize = 20;
    var cellSize = 20;
    var direction = 1;
    var cycleSpd = 5;
    var snakeSpd = 1;
    var track = 0;
    var turns = [];

    var snake = [
      {x: 3, y: 0, d: 4},
      {x: 2, y: 0, d: 4},
      {x: 1, y: 0, d: 4},
      {x: 0, y: 0, d: 4}
    ];

    var food = [];

    function gameInit() {
      canvas = document.getElementById('snake-canvas');
      if (canvas.getContext) {
        ctx = canvas.getContext('2d');
        window.addEventListener('keydown', gameKeydown, true);
        addFood();
        cycle = setInterval(gameCycle, cycleSpd);
      }
    }

    function gameCycle() {
      track += cycleSpd;
      if (track * snakeSpd >= 50 * cycleSpd) {
        track = 0;

        moveSnake();
        if (probably(2.5)) {
          addFood();
        }
        
        snakeSpd = snake.length / 10;
      }

      drawGrid();
      drawSnake();
      drawFood();
    }

    function addTurn(dir) {
      turns.push(dir);
    }

    function moveSnake() {
      var i;
      for (i = snake.length - 1; i >= 0; i--) {
        var next = snake[i - 1] || false;
        if (next && next.d != snake[i].d) {
          snake[i].d = next.d;
        }
      }

      var turn = turns.shift();
      if (turn) {
        snake[0].d = turn;
      }

      var lastSnake = {
        x: snake[snake.length - 1].x,
        y: snake[snake.length - 1].y,
        d: snake[snake.length - 1].d
      };

      for (i = 0; i < snake.length; i++) {
        movePart(snake[i]);
      }

      if (checkFood()) {
        snake.push(lastSnake);
      }
    }

    function checkFood() {
      for (i = 0; i < food.length; i++) {
        if (checkSnakeIntersection(food[i])) {
          food.splice(i, 1);
          if (probably(50)) {
            addFood();
          }
          return true;
        }
      }
      
      return false;
    }

    function rnd(min, max) {
      return Math.floor(Math.random() * max) + min;
    }
    
    function probably(chance) {
      return rnd(1, 10000) <= chance * 100;
    }

    function addFood() {
      while (1) {
        var newFood = {x: rnd(0, fieldSize - 1), y: rnd(0, fieldSize - 1)};
        if (!checkSnakeIntersection(newFood)) {
          food.push(newFood);
          return;
        }
      }
    }
    
    function checkSnakeIntersection(cell) {
      for (var i = 0; i < snake.length; i++) {
        if (snake[i].x == cell.x && snake[i].y == cell.y) {
          return true;
        }
      }
      
      return false;
    }

    function movePart(part) {
      switch (part.d) {
        case 1:
          part.y -= 1;
          break;
        case 2:
          part.x -= 1;
          break;
        case 3:
          part.y += 1;
          break;
        case 4:
          part.x += 1;
          break;
      }

      checkPartTeleport(part);
    }

    function checkPartTeleport(part) {
      if (part.x < 0) {
        part.x = fieldSize - 1;
      }
      if (part.y < 0) {
        part.y = fieldSize - 1;
      }
      if (part.x == fieldSize) {
        part.x = 0;
      }
      if (part.y == fieldSize) {
        part.y = 0;
      }
    }

    function gameKeydown(evt) {
      switch (evt.keyCode) {
        case 37:
          addTurn(DIR_L);
          break;
        case 38:
          addTurn(DIR_U);
          break;
        case 39:
          addTurn(DIR_R);
          break;
        case 40:
          addTurn(DIR_D);
          break;
      }
    }

    function drawGrid() {
      var bs = fieldSize * cellSize;
      ctx.clearRect(0, 0, bs, bs);

      ctx.lineWidth = 1;
      ctx.strokeStyle = COLOR_GRID;
      ctx.fillStyle = COLOR_GRID;

      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(0, bs);
      ctx.lineTo(bs, bs);
      ctx.lineTo(bs, 0);
      ctx.lineTo(0, 0);
      ctx.closePath();
      ctx.stroke();

      for (var i = 0; i < fieldSize; i++) {
        ctx.beginPath();
        ctx.moveTo(cellSize * i, 0);
        ctx.lineTo(cellSize * i, bs);
        ctx.closePath();
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(0, cellSize * i);
        ctx.lineTo(bs, cellSize * i);
        ctx.closePath();
        ctx.stroke();
      }
    }

    function drawSnake() {
      for (var i = 0; i < snake.length; i++) {
        drawCell(snake[i].x, snake[i].y, COLOR_SNAKE);
      }
    }

    function drawFood() {
      for (var i = 0; i < food.length; i++) {
        drawCell(food[i].x, food[i].y, COLOR_FOOD);
      }
    }

    function drawCell(x, y, color) {
      var p10 = cellSize * .1;
      var p20 = cellSize * .2;
      var p60 = cellSize * .6;

      ctx.lineWidth = p10;
      ctx.strokeStyle = color;
      ctx.fillStyle = color;

      ctx.beginPath();
      ctx.rect(
        x * cellSize,
        y * cellSize,
        cellSize,
        cellSize
      );
      ctx.closePath();
      ctx.stroke();

      ctx.fillRect(
        x * cellSize + p20,
        y * cellSize + p20,
        p60,
        p60
      );
    }
  </script>
</head>
<body onload="gameInit();">
<div id="snake-game">
  <canvas id="snake-canvas" width="500" height="500">
</div>
</body>
</html>
